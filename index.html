<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + TS</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
    <div
      style="
        margin: 20px;
        padding: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
      "
    >
      <h3>Spotify 인증 테스트</h3>
      <button
        id="test-spotify-simple"
        style="
          background-color: #1db954;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          margin: 10px 0;
        "
      >
        간소화된 Spotify 로그인 테스트
      </button>
      <div id="auth-result" style="margin-top: 10px"></div>
    </div>

    <script>
      // 간소화된 테스트 코드 - 복잡한 모듈 임포트 없이 직접 테스트
      document
        .getElementById('test-spotify-simple')
        .addEventListener('click', async function () {
          // 클라이언트 ID - 실제 ID로 교체
          const clientId = 'YOUR_CLIENT_ID_HERE';

          // 리디렉션 URI - 정확히 개발자 대시보드에 등록된 것과 일치해야 함
          const redirectUri = 'http://127.0.0.1:5173';

          // 랜덤 문자열 생성 (PKCE용 코드 검증기)
          function generateRandomString(length) {
            const possible =
              'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return Array.from(values)
              .map(x => possible[x % possible.length])
              .join('');
          }

          // 코드 검증기를 SHA-256으로 해시하여 코드 챌린지 생성
          async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await crypto.subtle.digest('SHA-256', data);

            return btoa(String.fromCharCode(...new Uint8Array(digest)))
              .replace(/=/g, '')
              .replace(/\+/g, '-')
              .replace(/\//g, '_');
          }

          try {
            // URL 파라미터 확인 (콜백 처리)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
              document.getElementById('auth-result').innerHTML =
                `<p style="color: red;">인증 오류: ${error}</p>`;
              return;
            }

            if (code) {
              // 코드를 받았으면 토큰으로 교환
              document.getElementById('auth-result').innerHTML =
                `<p>인증 코드 수신 성공! 토큰 교환 중...</p>`;

              const codeVerifier = localStorage.getItem(
                'spotify_simple_verifier',
              );
              if (!codeVerifier) {
                document.getElementById('auth-result').innerHTML =
                  `<p style="color: red;">코드 검증기를 찾을 수 없습니다.</p>`;
                return;
              }

              // 인증 코드를 토큰으로 교환
              const tokenResponse = await fetch(
                'https://accounts.spotify.com/api/token',
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                    client_id: clientId,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: redirectUri,
                    code_verifier: codeVerifier,
                  }).toString(),
                },
              );

              if (tokenResponse.ok) {
                const tokenData = await tokenResponse.json();
                document.getElementById('auth-result').innerHTML = `
              <p style="color: green;">인증 성공!</p>
              <pre style="background: #f8f8f8; padding: 10px; overflow: auto; max-height: 200px;">
    access_token: ${tokenData.access_token.substring(0, 10)}...
    refresh_token: ${tokenData.refresh_token ? tokenData.refresh_token.substring(0, 10) + '...' : '없음'}
    expires_in: ${tokenData.expires_in}
              </pre>
            `;

                // 토큰 저장
                localStorage.setItem(
                  'spotify_access_token',
                  tokenData.access_token,
                );
                if (tokenData.refresh_token) {
                  localStorage.setItem(
                    'spotify_refresh_token',
                    tokenData.refresh_token,
                  );
                }

                // URL 정리
                history.replaceState({}, document.title, '/');
              } else {
                const errorData = await tokenResponse.json();
                document.getElementById('auth-result').innerHTML =
                  `<p style="color: red;">토큰 교환 실패: ${JSON.stringify(errorData)}</p>`;
              }
            } else {
              // 코드가 없으면 인증 시작
              const codeVerifier = generateRandomString(64);
              localStorage.setItem('spotify_simple_verifier', codeVerifier);

              const codeChallenge = await generateCodeChallenge(codeVerifier);

              // 인증 URL 생성
              const params = new URLSearchParams({
                client_id: clientId,
                response_type: 'code',
                redirect_uri: redirectUri,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
                scope: 'user-read-private user-read-email streaming',
              });

              const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
              console.log('인증 URL:', authUrl);
              console.log('리디렉션 URI:', redirectUri);

              // Spotify 인증 페이지로 리디렉션
              window.location.href = authUrl;
            }
          } catch (error) {
            console.error('인증 오류:', error);
            document.getElementById('auth-result').innerHTML =
              `<p style="color: red;">인증 처리 중 오류: ${error.message}</p>`;
          }
        });

      // 페이지 로드 시 URL 파라미터 확인
      window.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        // 코드가 있으면 자동으로 처리
        if (code) {
          document.getElementById('test-spotify-simple').click();
        }
      });
    </script>
  </body>
</html>
